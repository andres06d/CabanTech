<!DOCTYPE html>
<html>

<head>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/flowbite/1.6.5/flowbite.min.js"></script>
    <link href="https://fonts.googleapis.com/css?family=Poppins" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
        integrity="sha512-iecdLmaskl7CVkqkXNQ/ZH/XLlvWZOJyj7Yy7tcenmpD1ypASozpmT/E0iPtmFIB46ZmdtAc9eNBvH0H/ZpiBw=="
        crossorigin="anonymous" referrerpolicy="no-referrer" />
    <link rel="shortcut icon" href="images/logocab-white.png" type="image/x-icon">

    <title>CabanTech</title>
    <link rel="shortcut icon" href="../images/logocab-white.png" type="image/x-icon">
    <meta charset="UTF-8">
</head>

<body class="bg-gray-100 font-[Poppins]">
    <header>
        <nav class="bg-stone-900 border-stone-900 px-4 lg:px-6 py-2.5">
            <div class="flex flex-wrap justify-between items-center mx-auto max-w-screen-xl">
                <a href="ini.html" class="flex items-center">
                    <img src="../images/logocab-white.png" class="mr-3 h-6 sm:h-9" alt="CabanTech" />
                    <span class="self-center text-xl font-semibold whitespace-nowrap text-white">CabanTech</span>
                </a>
                <div class="flex items-center lg:order-2">
                    <a href="#" onclick="logout()"
                        class="text-white hover:bg-red-600 focus:ring-4 focus:ring-red-600 font-medium rounded-lg text-sm px-5 py-2.5 mr-2 focus:outline-none">Cerrar
                        Sesion</a>
                    <a href="admin.html"
                        class="fa-solid fa-screwdriver-wrench text-white p-2 rounded-md hover:bg-orange-600 shadow-lg shadow-orange-600/50"></a>
                </div>
                <button type="button"
                    class="flex mr-3 text-sm bg-stone-900 hover:rounded-full hover:ring-4 hover:bg-orange-600 md:mr-0 focus:ring-4 focus:ring-orange-600 focus:rounded-full"
                    id="user-menu-button" aria-expanded="false" data-dropdown-toggle="user-dropdown"
                    data-dropdown-placement="bottom">
                    <span class="sr-only">Abrir menu de usuario</span>
                    <img class="w-8 h-8 rounded-full" src="../images/user_h.png" alt="foto usuario">
                </button>
                <!-- Dropdown menu -->
                <div class="z-50 hidden my-4 text-base list-none bg-stone-700 divide-y divide-gray-100 rounded-lg shadow"
                    id="user-dropdown">
                    <div class="px-4 py-3">
                        <span class="block text-sm text-gray-900 dark:text-white" id ="SpamNombreUsuario">Luis Negrette</span>
                        <span class="block text-sm  text-gray-500 truncate dark:text-gray-400" id="SpamCorreoUsuario">luis@cabantech.com</span>
                    </div>
                </div>
        </nav>
    </header>

    <div class="flex gap-2 px-4 py-6">
        <div>
            <label class="block font-bold mb-1">Nombre:</label>
            <input type="text" id="filter-led-number" class="border border-gray-300 rounded px-2 py-1 w-full">
        </div>
        <div class="flex items-end mt-6">
            <button id="buscar"
                class="p-1 hover:bg-orange-600 rounded-md bg-stone-900 text-white border border-orange-600">Buscar</button>
        </div>
    </div>

    <table id="resultados" class="w-full text-sm text-left text-black border-collapse px-4">
        <thead class="text-xs text-white uppercase bg-stone-900">
            <tr>
                <th scope="col" class="px-6 py-3">Nombre</th>
                <th scope="col" class="px-6 py-3">Apellidos</th>
                <th scope="col" class="px-6 py-3">Seleccionar</th>
            </tr>
        </thead>
        <tbody>
            <!-- Aquí se agregarán las filas de resultados -->
        </tbody>
    </table>

    <div class="grid grid-cols-2 gap-4 py-4 grid-auto-rows max-content px-4">
        <!-- Columna izquierda -->
        <div>
            <h2 class="text-2xl font-bold mb-4">Modificar Usuario</h2>
            <div class="flex flex-col gap-4">
                <div class="flex">
                    <div class="w-1/2 pr-2">
                        <label class="block font-bold mb-1">Nombre:</label>
                        <input type="text" id="nombreuser" class="border border-gray-300 rounded px-2 py-1 w-full">
                    </div>
                    <div class="w-1/2 pl-2">
                        <label class="block font-bold mb-1">Apellido:</label>
                        <input type="text" id="apellidouser" class="border border-gray-300 rounded px-2 py-1 w-full">
                    </div>
                </div>
                <div class="flex">
                    <div class="w-1/2 pr-2">
                        <label class="block font-bold mb-1">Tipo de Documento:</label>
                        <select id="asgina" name="tipoid" class="px-2 py-1 border rounded w-full">
                            <option value="1">NUIP</option>
                            <option value="2">Cedula de Ciudadania</option>
                            <option value="3">Tarjeta de Identidad</option>
                            <option value="4">Pasaporte</option>
                            <option value="5">Cedula de Extranjeria</option>
                        </select>
                    </div>
                    <div class="w-1/2 pl-2">
                        <label class="block font-bold mb-1">Número de Documento:</label>
                        <input type="text" id="numeroid" class="border border-gray-300 rounded px-2 py-1 w-full">
                    </div>
                </div>
                <div class="flex">
                    <div class="w-1/2 pr-2">
                        <label class="block font-bold mb-1">Teléfono:</label>
                        <input type="text" id="tel" class="border border-gray-300 rounded px-2 py-1 w-full">
                    </div>
                    <div class="w-1/2 pl-2">
                        <label class="block font-bold mb-1">Dirección:</label>
                        <input type="text" id="direc" class="border border-gray-300 rounded px-2 py-1 w-full">
                    </div>
                </div>
                <div class="flex">
                    <div class="w-1/2 pr-2">
                        <label class="block font-bold mb-1">Fecha de Nacimiento:</label>
                        <input type="date" id="fechanacimiento">
                    </div>
                    <div class="w-1/2 pl-2">
                        <label class="block font-bold mb-1">Contraseña:</label>
                        <input type="text" id="contra" class="border border-gray-300 rounded px-2 py-1 w-full">
                    </div>
                </div>

            </div>
            <div class="mt-4 text-center">
                <button id="modificaruser"
                    class="p-2 hover:bg-orange-600 rounded-md bg-stone-900 text-white border border-orange-600">Guardar</button>
            </div>


            <div class="flex gap-2">
                <div class="w-1/2">
                    <label class="block font-bold mb-1">Seleccione la Cabaña:</label>
                    <select id="selectcabana" name="cabananom" class="px-2 py-1 border rounded w-full">
                        <option value="0">Seleccionar la Cabaña</option>
                    </select>
                </div>
                <div class="flex items-end mt-6 w-1/2">
                    <button id="seleccioncabana"
                        class="p-1 hover:bg-orange-600 rounded-md bg-stone-900 text-white border border-orange-600 w-32 mx-auto">Seleccionar</button>
                </div>
                <div class="flex items-end mt-6 w-1/2">
                    <button id="seleccioncabana2"
                        class="p-1 hover:bg-orange-600 rounded-md bg-stone-900 text-white border border-orange-600 w-44 mx-auto">Cambiar
                        Cabaña</button>
                </div>
            </div>
        </div>

        <!-- Columna derecha -->
        <div>
            <img src="../images/logocab.png" class="w-3/5 mx-auto" alt="Cabantech Logo">
        </div>


    </div>

    <script>
        var id_usuario;
        var Nombre = document.getElementById('SpamNombreUsuario');
        var Correo = document.getElementById('SpamCorreoUsuario');
        var sessionCookie = document.cookie.replace(/(?:(?:^|.*;\s*)session\s*=\s*([^;]*).*$)|^.*$/, '$1');
        var userDataCookie = document.cookie.replace(/(?:(?:^|.*;\s*)datos_usuario\s*=\s*([^;]*).*$)|^.*$/, '$1');
        userDataCookie = decodeURIComponent(userDataCookie);
        var userData = JSON.parse(userDataCookie);


        if (!sessionCookie) {
            // Si la cookie de sesión no está presente, redirigir al usuario a la página de inicio de sesión
            window.location.href = '../index.html';
        } else if (userDataCookie) {
            // Si la cookie de datos del usuario está presente, decodificarla y mostrar su contenido en la consola
            try {

                Nombre.textContent = userData.nombre;
                Correo.textContent = userData.correo;
                console.log(userData);
            } catch (error) {
                console.error("Error al analizar la cookie de datos_usuario:", error);
            }
        }

        // Función para borrar la cookie de sesión y cerrar sesión
        function logout() {
            document.cookie = 'session=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=/;';
            // Redirigir al usuario a la página de inicio de sesión
            window.location.href = '../index.html';
        }

        window.addEventListener('load', function () {
            if (userData.Rol !== 'Administrador') {
                // Redirige al usuario a ini.html si no es un administrador
                window.location.href = 'ini.html';
            }
        });


        // Llenar el select con las opciones de cabañas
        function obtenerCabañas() {
            return axios.get('../php/obtener_cabañas.php')
                .then(function (response) {
                    console.log(response.data)
                    return response.data;
                })
                .catch(function (error) {
                    console.error('Error al obtener cabañas:', error);
                });
        }

        obtenerCabañas().then(function (cabañas) {
            var selectCabana = document.getElementById('selectcabana');
            cabañas.forEach(function (cabana) {
                var option = document.createElement('option');
                option.value = cabana["ID Cabaña"];
                option.text = cabana["Nombre"];
                selectCabana.add(option);
            });
        });





        // Obtener el elemento del botón por su ID
        var seleccionCabanaBtn = document.getElementById('seleccioncabana');

        // Agregar un evento de clic al botón
        seleccionCabanaBtn.addEventListener('click', function () {
            // Obtener el valor seleccionado en el elemento select
            var cabañaSeleccionadaID = selectCabana.value;

            // Buscar la cabaña seleccionada en el array de cabañas en userData
            var cabañaSeleccionada = userData.cabañas.find(function (cabana) {
                return cabana['ID Cabaña'] === cabañaSeleccionadaID;
            });

            // Actualizar la propiedad cabañaSeleccionada en userData
            if (cabañaSeleccionada) {
                userData.cabañaSeleccionada = cabañaSeleccionada;
            }

            // Actualizar la cookie 'datos_usuario' con la nueva información
            document.cookie = 'datos_usuario=' + encodeURIComponent(JSON.stringify(userData)) + '; path=/';

            // Mostrar en la consola la información actualizada
            console.log('userData actualizado:', userData);
        });







        var miBoton = document.getElementById('modificaruser');

        // Agregar un evento de clic al botón
        miBoton.addEventListener('click', function () {


            var nombre = document.getElementById('nombreuser').value;
            var apellido = document.getElementById('apellidouser').value;
            // Obtener otros campos de entrada de manera similar
            var tipoDocumento = document.getElementById('asgina').value;
            var numeroDocumento = document.getElementById('numeroid').value;
            var telefono = document.getElementById('tel').value;
            var direccion = document.getElementById('direc').value;
            var fechaNacimiento = document.getElementById('fechanacimiento').value;
            var contrasena = document.getElementById('contra').value;

            // Hacer algo con el contenido, por ejemplo, mostrarlo en la consola
            console.log('Nombre: ' + nombre);
            console.log('Apellido: ' + apellido);
            console.log('Tipo de Documento: ' + tipoDocumento);
            console.log('Número de Documento: ' + numeroDocumento);
            console.log('Teléfono: ' + telefono);
            console.log('Dirección: ' + direccion);
            console.log('Fecha de Nacimiento: ' + fechaNacimiento);
            console.log('Contraseña: ' + contrasena);

            var usuarioID = usuarioID = userData['id usuario']

            var formData = new FormData();
            formData.append('usuario_id', usuarioID);
            formData.append('nombre', nombre);
            formData.append('apellidos', apellido);
            formData.append('tipoDocumento', tipoDocumento);
            formData.append('numeroDocumento', numeroDocumento);
            formData.append('telefono', telefono);
            formData.append('direccion', direccion);
            formData.append('fechaNacimiento', fechaNacimiento);
            formData.append('contrasena', contrasena);
            axios.post("../php/actualizar_usuario.php", formData)
                .then(function (response) {

                    console.log(response.data);
                    alert(response.data);
                })
                .catch(function (error) {
                    console.error(error);
                });





        });





        function ObtenerUsuario(usuarioID) {
            
            var nombre = document.getElementById('nombreuser');
            var apellido = document.getElementById('apellidouser');
            var tipoDocumento = document.getElementById('asgina');
            var numeroDocumento = document.getElementById('numeroid');
            var telefono = document.getElementById('tel');
            var direccion = document.getElementById('direc');
            var fechaNacimiento = document.getElementById('fechanacimiento');
            var contrasena = document.getElementById('contra');

            var formData = new FormData();
            formData.append('usuario_id', usuarioID);
            console.log(usuarioID);

            axios.post("../php/consulta_usuario.php", formData)
                .then(function (response) {
                    // Llenar los campos del formulario con los datos obtenidos
                    var data = response.data;
                    console.log(data);

                    // Asignar valores a los elementos del DOM
                    nombre.value = data.Nombre;
                    apellido.value = data.Apellidos;
                    numeroDocumento.value = data['Numero de Documento'];
                    telefono.value = data.Telefono;
                    direccion.value = data.Direccion;
                    fechaNacimiento.value = data['Fecha de Nacimiento'];
                    contrasena.value = data.Contraseña;

                    // Seleccionar la opción correcta en el select
                    // Asegúrate de que 'tipoDocumento' es un objeto jQuery


                    var options = tipoDocumento.options;
                    for (var i = 0; i < options.length; i++) {
                        if (options[i].text === data['Tipo de Documento']) {
                            options[i].selected = true;
                            break;
                        }
                    }
                })
                .catch(function (error) {
                    console.error(error);
                });
        }
        var botol = document.getElementById('buscar');
        document.addEventListener('DOMContentLoaded', function () {
            document.getElementById('buscar').addEventListener('click', function () {
                var filtroNombre = document.getElementById('filter-led-number').value;

                var updateFormData = new FormData();
                updateFormData.append("filtroNombre", filtroNombre);

                axios.post('../php/buscar_usuarios.php', updateFormData)
                    .then(function (response) {
                        var data = response.data;

                        var tbody = document.querySelector('#resultados tbody');
                        tbody.innerHTML = '';

                        for (var i = 0; i < data.length; i++) {
                            var row = document.createElement('tr');

                            var tdNombre = document.createElement('td');
                            tdNombre.textContent = data[i].Nombre;
                            row.appendChild(tdNombre);

                            var tdApellidos = document.createElement('td');
                            tdApellidos.textContent = data[i].Apellidos;
                            row.appendChild(tdApellidos);

                            var tdSeleccionar = document.createElement('td');
                            var button = document.createElement('button');
                            button.classList.add('px-6', 'py-3', 'cursor-pointer', 'text-stone-900', 'seleccionar-btn');
                            button.dataset.id = data[i].ID;
                            button.textContent = 'Seleccionar';
                            tdSeleccionar.appendChild(button);
                            row.appendChild(tdSeleccionar);

                            tbody.appendChild(row);
                        }
                    })
                    .catch(function (error) {
                        console.error('Error al buscar usuarios:', error);
                    });
            });

            document.getElementById('resultados').addEventListener('click', function (event) {
                if (event.target.classList.contains('seleccionar-btn')) {
                    var userID = event.target.dataset.id;
                    console.log('el usuario es ' + userID);
                    ObtenerUsuario(userID);
                    console.log('ID Usuario seleccionado:', userID);

                    // Cambiar el color del botón al hacer clic
                    if (event.target.classList.contains('text-stone-900')) {
                        event.target.classList.remove('text-stone-900');
                        event.target.classList.add('text-orange-600');
                    } else {
                        event.target.classList.remove('text-orange-600');
                        event.target.classList.add('text-stone-900');
                    }
                }
            });
        });

        var selectCabana = document.getElementById('seleccioncabana');
        selectCabana.addEventListener('change', function () {
            var idCabanaSeleccionada = this.value;
            var idUsuario = id_usuario;

            axios.post('../php/actualizar_id_usuario.php', {
                idCabana: idCabanaSeleccionada,
                idUsuario: idUsuario
            })
                .then(function (response) {
                    console.log('ID de usuario actualizado con éxito en la cabaña seleccionada');
                })
                .catch(function (error) {
                    console.error('Error al actualizar ID de usuario:', error);
                });
        });


        


        var seleccionCabanaBtn = document.getElementById('seleccioncabana2');
        var seleccion = document.getElementById('selectcabana');

        // Agregar un evento de clic al botón
        seleccionCabanaBtn.addEventListener('click', function () {
            // Obtener el valor seleccionado en el elemento select
            var cabañaSeleccionadaID = seleccion.value;

            // Hacer una solicitud HTTP GET a obtener_cabañas.php
            fetch('../php/obtener_cabañas.php')
                .then(function (response) {
                    // Parsear la respuesta como JSON
                    return response.json();
                })
                .then(function (cabañas) {
                    // Buscar la cabaña seleccionada en el array de cabañas
                    var cabañaSeleccionada = cabañas.find(function (cabana) {
                        return cabana['ID Cabaña'] === cabañaSeleccionadaID;
                    });

                    // Actualizar la propiedad cabañaSeleccionada en userData
                    if (cabañaSeleccionada) {
                        userData.cabañaSeleccionada = cabañaSeleccionada;
                    }

                    // Actualizar la cookie 'datos_usuario' con la nueva información
                    document.cookie = 'datos_usuario=' + encodeURIComponent(JSON.stringify(userData)) + '; path=/';

                    // Mostrar en la consola la información actualizada
                    console.log('userData actualizado:', userData);
                });
        });




    </script>

</body>

</html>